<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anunciar Novo - Ocean Coffee</title>
    <link rel="icon" href="IMG/Loginho2.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="CSS/styles.css"> <script src="https://unpkg.com/imask"></script>
    <style>
        /* ESTILOS GERAIS */
        :root { --color-primary: #0047a3; --color-danger: #dc3545; --color-text: #212529; --color-text-muted: #6c757d; --color-background: #f8f9fa; --color-surface: #ffffff; --color-border: #e9ecef; --font-family-main: 'Inter', sans-serif; }
        body { background-color: var(--color-background); font-family: var(--font-family-main); color: var(--color-text); margin: 0; }
        .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .dashboard-main { overflow-y: auto; padding: 2.5rem; }

        /* SIDEBAR */
        .dashboard-sidebar { background-color: var(--color-surface); border-right: 1px solid var(--color-border); display: flex; flex-direction: column; padding: 1.5rem; }
        .sidebar-header { padding: 0 0.5rem 1.5rem 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); text-align: center; }
        .sidebar-header .logo-img { height: 50px; }
        .user-profile-summary { text-align: center; margin-bottom: 2rem; }
        .user-profile-summary .avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; margin: 0 auto 1rem auto; }
        .user-profile-summary h3 { font-size: 1.1rem; font-weight: 600; margin: 0; }
        .user-profile-summary p { font-size: 0.875rem; color: var(--color-text-muted); word-break: break-all; }
        .sidebar-nav { flex-grow: 1; display: flex; flex-direction: column; }
        .sidebar-nav-main { display: flex; flex-direction: column; gap: 0.5rem; }
        .sidebar-nav-logout { margin-top: auto; }
        .sidebar-nav a { display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; border-radius: 8px; text-decoration: none; color: var(--color-text-muted); font-weight: 500; transition: all 0.2s ease; }
        .sidebar-nav a:hover { background-color: var(--color-background); color: var(--color-text); }
        .sidebar-nav a.active { background-color: var(--color-primary); color: white; }
        .sidebar-nav a i { width: 20px; text-align: center; font-size: 1.1rem; }
        #logout-btn:hover { color: var(--color-danger); background-color: #fbebee; }
        
        /* CONTEÚDO PRINCIPAL E FORMULÁRIO */
        .dashboard-main h1 { font-size: 2rem; font-weight: 700; margin-bottom: 2rem; }
        #anuncioForm { display: flex; flex-direction: column; gap: 1.5rem; }
        .form-section { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.75rem; }
        .form-section h3 { font-size: 1.2rem; font-weight: 600; color: var(--color-primary); padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 0.75rem; margin-top: 0; }
        .image-upload-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .image-upload-box { border: 2px dashed var(--color-border); border-radius: 10px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; background-color: var(--color-background); aspect-ratio: 16 / 10; display: flex; align-items: center; justify-content: center; }
        .image-upload-box:hover { border-color: var(--color-primary); }
        .image-upload-box input[type="file"] { display: none; }
        .upload-placeholder { text-align: center; color: var(--color-text-muted); }
        .upload-placeholder i { font-size: 2rem; margin-bottom: 0.5rem; color: var(--color-primary); }
        .upload-placeholder p { font-weight: 500; }
        .image-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; }
        .fields-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group input { width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; font-family: var(--font-family-main); }
        .form-group input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 71, 163, 0.1); }
        .form-actions { display: flex; justify-content: flex-end; margin-top: 1rem; }
        .publicar-btn { background: linear-gradient(to right, #0047a3, #3ac0dd); color: #fff; padding: 0.875rem 2rem; border-radius: 8px; border: none; font-weight: 500; font-size: 1rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .publicar-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 71, 163, 0.2); }
        .publicar-btn:disabled { background: #adb5bd; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ESTILOS DOS POP-UPS (INTEGRADOS) */
        .popup-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        .popup { display: flex; align-items: center; min-width: 300px; padding: 16px 22px; border-radius: 8px; color: white; font-family: 'Inter', sans-serif; font-size: 0.95rem; font-weight: 500; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); transform: translateX(calc(100% + 20px)); opacity: 0; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .popup.show { transform: translateX(0); opacity: 1; }
        .popup i { font-size: 1.25rem; margin-right: 14px; }
        .popup.success { background-color: #28a745; }
        .popup.error { background-color: #dc3545; }
        .popup.info { background-color: #0d6efd; }
        .confirmation-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9998; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .confirmation-overlay.show { opacity: 1; }
        .confirmation-modal { background-color: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 400px; width: 90%; transform: scale(0.9); opacity: 0; transition: all 0.3s ease; }
        .confirmation-overlay.show .confirmation-modal { transform: scale(1); opacity: 1; }
        .confirmation-modal h3 { font-size: 1.25rem; font-weight: 600; margin-top: 0; margin-bottom: 0.75rem; }
        .confirmation-modal p { color: #6c757d; margin-bottom: 1.75rem; }
        .confirmation-actions { display: flex; gap: 1rem; justify-content: center; }
        .confirmation-actions button { border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-family: 'Inter', sans-serif; font-weight: 500; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; }
        .confirmation-btn-cancel { background-color: #e9ecef; color: #495057; }
        .confirmation-btn-cancel:hover { background-color: #dee2e6; }
        .confirmation-btn-confirm { background-color: #dc3545; color: white; }
        .confirmation-btn-confirm:hover { background-color: #c82333; }

        @media (max-width: 992px) { .dashboard-layout { grid-template-columns: 1fr; } .dashboard-sidebar { display: none; } .dashboard-main { padding: 1.5rem; } }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="dashboard-sidebar">
            <div class="sidebar-header"><a href="index.html"><img src="IMG/Loginho2.png" alt="Logo Ocean Coffee" class="logo-img"></a></div>
            <div class="user-profile-summary">
                <div class="avatar" id="avatar-inicial"></div>
                <h3 id="welcome-message">Carregando...</h3>
                <p id="user-email-sidebar"></p>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-main">
                    <a href="perfil.html"><i class="fas fa-user-circle"></i><span>Meu Perfil</span></a>
                    <a href="meus-anuncios.html"><i class="fas fa-bullhorn"></i><span>Meus Anúncios</span></a>
                    <a href="anuncie.html" class="active"><i class="fas fa-plus-circle"></i><span>Anunciar Novo</span></a>
                </div>
                <div class="sidebar-nav-logout"><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></div>
            </nav>
        </aside>
        <main class="dashboard-main">
            <h1>Criar Novo Anúncio</h1>
            <form id="anuncioForm">
                <div class="form-section">
                    <h3><i class="fas fa-images"></i> Imagens do Anúncio</h3>
                    <div class="image-upload-container">
                        <label for="imagem1" class="image-upload-box"><input type="file" id="imagem1" data-preview-id="preview1"><div class="upload-placeholder" id="placeholder1"><i class="fas fa-camera"></i><p>Imagem Principal</p></div><img src="" class="image-preview" id="preview1"></label>
                        <label for="imagem2" class="image-upload-box"><input type="file" id="imagem2" data-preview-id="preview2"><div class="upload-placeholder" id="placeholder2"><i class="fas fa-plus"></i><p>Imagem 2</p></div><img src="" class="image-preview" id="preview2"></label>
                        <label for="imagem3" class="image-upload-box"><input type="file" id="imagem3" data-preview-id="preview3"><div class="upload-placeholder" id="placeholder3"><i class="fas fa-plus"></i><p>Imagem 3</p></div><img src="" class="image-preview" id="preview3"></label>
                    </div>
                </div>
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Detalhes do Anúncio</h3>
                    <div class="fields-grid">
                        <div class="form-group full-width"><input type="text" id="produto" placeholder="Título do anúncio (Ex: Máquina de Espresso La Marzocco)" required></div>
                        <div class="form-group full-width"><input type="text" id="descricao" placeholder="Descreva seu produto em detalhes..." required></div>
                        <div class="form-group"><input type="text" id="preco" placeholder="Preço (R$)" required></div>
                        <div class="form-group"><input type="text" id="local" placeholder="Cidade e Estado (Ex: Campinas, SP)" required></div>
                        <div class="form-group"><input type="text" id="telefone" placeholder="Seu telefone de contato" required></div>
                    </div>
                    <div class="form-actions">
                         <button type="submit" id="publicarBtn" class="publicar-btn">
                            <i class="fas fa-paper-plane"></i> Enviar para Análise
                        </button>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.1/+esm";
        
        // --- LÓGICA DE SEGURANÇA E POP-UPS (INTEGRADA) ---
        const supabaseUrl = "https://uldxazlnnpuoxfzsovmu.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZHhhemxubnB1b3hmenNvdm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3Mjg2NzgsImV4cCI6MjA2NDMwNDY3OH0.fyToys8_muc1XyUebJ19gxGEkCVM_cXg80UJR894xQY";
        const supabase = createClient(supabaseUrl, supabaseKey);

        async function protegerPagina() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace('Login.html'); }
        }
        protegerPagina();

        function ensurePopupContainer() { let c = document.getElementById('popup-container'); if (!c) { c = document.createElement('div'); c.id = 'popup-container'; c.className = 'popup-container'; document.body.appendChild(c); } return c; }
        function showPopup(message, type = 'info', duration = 3500) { const c = ensurePopupContainer(); const p = document.createElement('div'); p.className = `popup ${type}`; let i = 'fas fa-info-circle'; if (type === 'success') i = 'fas fa-check-circle'; if (type === 'error') i = 'fas fa-times-circle'; p.innerHTML = `<i class="${i}"></i> <div>${message}</div>`; c.prepend(p); requestAnimationFrame(() => p.classList.add('show')); setTimeout(() => { p.classList.remove('show'); p.addEventListener('transitionend', () => p.remove()); }, duration); }
        function showConfirmationPopup(title, message) { return new Promise((resolve) => { const o = document.createElement('div'); o.className = 'confirmation-overlay'; o.innerHTML = `<div class="confirmation-modal"><h3>${title}</h3><p>${message}</p><div class="confirmation-actions"><button class="confirmation-btn-cancel">Cancelar</button><button class="confirmation-btn-confirm">Sim, Sair</button></div></div>`; const c = (r) => { o.classList.remove('show'); o.addEventListener('transitionend', () => { o.remove(); resolve(r); }); }; o.querySelector('.confirmation-btn-cancel').addEventListener('click', () => c(false)); o.querySelector('.confirmation-btn-confirm').addEventListener('click', () => c(true)); document.body.appendChild(o); requestAnimationFrame(() => o.classList.add('show')); }); }

        // --- LÓGICA DA PÁGINA "ANUNCIAR NOVO" ---
        document.addEventListener("DOMContentLoaded", async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            
            const { data: profile } = await supabase.from("usuarios").select("nome, email").eq("user_id", user.id).single();
            if (profile) {
                document.getElementById('welcome-message').textContent = profile.nome.split(' ')[0];
                document.getElementById('user-email-sidebar').textContent = profile.email;
                document.getElementById('avatar-inicial').textContent = profile.nome.charAt(0).toUpperCase();
            }
            
            const form = document.getElementById('anuncioForm');
            const precoInput = document.getElementById('preco');
            const telefoneInput = document.getElementById('telefone');
            
            const formatarPreco = (evento) => {
                let input = evento.target; let valor = input.value.replace(/\D/g, ''); if (valor === '') { input.value = ''; return; }
                let valorNumerico = Number(valor) / 100;
                input.value = valorNumerico.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };
            precoInput.addEventListener('input', formatarPreco);

            const telefoneMask = IMask(telefoneInput, { mask: [ { mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' } ] });

            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function(event) {
                    const file = event.target.files[0]; if (!file) return;
                    const previewId = this.dataset.previewId;
                    const previewElement = document.getElementById(previewId);
                    const placeholderElement = document.getElementById(previewId.replace('preview', 'placeholder'));
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewElement.src = e.target.result;
                        previewElement.style.display = 'block';
                        if (placeholderElement) placeholderElement.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                });
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('publicarBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';

                try {
                    const { data: { user: currentUser } } = await supabase.auth.getUser();
                    if (!currentUser) throw new Error("Sessão inválida. Faça o login novamente.");
                    
                    const { data: currentProfile } = await supabase.from("usuarios").select("nome").eq("user_id", currentUser.id).single();
                    if (!currentProfile) throw new Error("Não foi possível encontrar seu perfil.");

                    const produto = document.getElementById("produto").value.trim();
                    const local = document.getElementById("local").value.trim();
                    const precoFormatado = precoInput.value;
                    const precoNumerico = parseFloat(precoFormatado.replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.'));
                    const descricao = document.getElementById("descricao").value.trim();
                    const contato = telefoneMask.unmaskedValue;

                    if (!produto || !local || isNaN(precoNumerico) || !descricao || !contato) throw new Error("Preencha todos os campos obrigatórios.");
                    
                    const files = [document.getElementById('imagem1').files[0], document.getElementById('imagem2').files[0], document.getElementById('imagem3').files[0]].filter(Boolean);
                    if (files.length === 0) throw new Error("Selecione pelo menos a Imagem Principal.");
                    
                    const imagens = [];
                    for (const file of files) {
                        const sanitizedName = file.name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '_');
                        const path = `produtos/${currentUser.id}/${Date.now()}_${sanitizedName}`;
                        const { error: uploadError } = await supabase.storage.from('imagens').upload(path, file);
                        if (uploadError) throw new Error(`Erro no upload da imagem: ${uploadError.message}`);
                        const { data: urlData } = supabase.storage.from('imagens').getPublicUrl(path);
                        imagens.push(urlData.publicUrl);
                    }
                    
                    const { error: insertError } = await supabase.from("produtos").insert({
                        user_id: currentUser.id, nome_usuario: currentProfile.nome,
                        produto, local, preco: precoNumerico, descricao, contato, imagens,
                        data: new Date().toISOString()
                    });
                    if (insertError) throw insertError;
                    
                    showPopup("Anúncio enviado para análise!", 'success');
                    setTimeout(() => window.location.href = "meus-anuncios.html", 2000);

                } catch (err) {
                    showPopup(err.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar para Análise';
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async (e) => { 
                e.preventDefault(); 
                const userConfirmed = await showConfirmationPopup('Confirmar Saída', 'Você tem certeza que deseja sair da sua conta?');
                if (userConfirmed) { await supabase.auth.signOut(); window.location.replace("index.html"); }
            });
        });
    </script>
</body>
</html>