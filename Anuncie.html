<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ocean Coffee - Anuncie seu Produto</title>
    <link rel="icon" href="IMG/Loginho2.png" type="image/png">
    
    <link rel="stylesheet" href="CSS/styles.css" />
    <link rel="stylesheet" href="CSS/anuncie.css">
    <link rel="stylesheet" href="CSS/popup-anuncie.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://use.typekit.net/hta6hdp.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.0.23/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/imask"></script>
</head>

<body>
    <header class="navbar">
        <div class="navbar-left">
            <span class="currency">U$</span>
            <i class="fas fa-arrow-up up-icon"></i>
            <a href="MarketPlace.html"><i class="fas fa-store"></i></a>
        </div>
        <nav class="navbar-center">
            <a href="Index.html">Nosso Café</a>
            <a href="Index.html">Serviços</a>
            <a href="Index.html">Sobre</a>
            <a href="Login.html">Login</a>
        </nav>
        <div class="navbar-right">
            <i class="fas fa-sun"></i>
            <span class="temp">30°C</span>
            <i class="fas fa-chevron-down"></i>
        </div>
    </header>

    <section>
        <form class="containe" id="anuncioForm">
            <div class="imagem-section space-y-4">
                <div class="container_file">
                    <label class="block text-gray-700 font-semibold mb-1" for="imagem1">Imagem 1:</label>
                    <input type="file" id="imagem1" name="imagem1" accept="image/*" class="block w-full text-sm text-gray-700 bg-white border border-gray-300 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition duration-150">
                </div> <br>
                <div class="container_file">
                    <label class="block text-gray-700 font-semibold mb-1" for="imagem2">Imagem 2:</label>
                    <input type="file" id="imagem2" name="imagem2" accept="image/*" class="block w-full text-sm text-gray-700 bg-white border border-gray-300 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition duration-150">
                </div> <br>
                <div class="container_file">
                    <label class="block text-gray-700 font-semibold mb-1" for="imagem3">Imagem 3:</label>
                    <input type="file" id="imagem3" name="imagem3" accept="image/*" class="block w-full text-sm text-gray-700 bg-white border border-gray-300 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition duration-150">
                </div>
                <div class="button-container2 pt-2">
                    <button type="submit" id="publicarBtn" class="publicar-btn">
                        <img src="IMG/Loginho.png" alt="Publicar" class="icon2">
                        Publicar
                    </button>
                </div>
            </div>
            <div class="form-section">
                <input type="text" id="produto" name="produto" placeholder="Produto" required>
                <input type="text" id="local" name="local" placeholder="Localização" required>
                <input type="text" id="preco" name="preco" placeholder="Preço" required>
                <input type="text" id="descricao" name="descricao" placeholder="Descrição" required>
                <input type="text" id="telefone" name="contato" placeholder="Telefone de Contato" required>
            </div>
        </form>
    </section>

    <footer class="footer">
        </footer>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabaseUrl = "https://uldxazlnnpuoxfzsovmu.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZHhhemxubnB1b3hmenNvdm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3Mjg2NzgsImV4cCI6MjA2NDMwNDY3OH0.fyToys8_muc1XyUebJ19gxGEkCVM_cXg80UJR894xQY";
        const supabase = createClient(supabaseUrl, supabaseKey);

        function sanitizeFilename(filename) {
            const noAccents = filename.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            return noAccents.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '');
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById('anuncioForm');
            if (!form) {
                console.error("Erro crítico: Formulário com ID 'anuncioForm' não foi encontrado.");
                return;
            }
            
            const precoInput = document.getElementById('preco');
            const telefoneInput = document.getElementById('telefone');

            // LÓGICA PERSONALIZADA PARA O CAMPO DE PREÇO
            const formatarPreco = (evento) => {
                let input = evento.target;
                let valor = input.value.replace(/\D/g, '');
                if (valor === '') {
                    input.value = '';
                    return;
                }
                let valorNumerico = Number(valor) / 100;
                input.value = valorNumerico.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };
            precoInput.addEventListener('input', formatarPreco);

            // LÓGICA DA BIBLIOTECA IMask.js PARA O TELEFONE
            const telefoneMask = IMask(telefoneInput, {
                mask: [ { mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' } ]
            });

            // LÓGICA DE ENVIO COMPLETA
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('publicarBtn');
                btn.disabled = true;
                btn.textContent = "Publicando...";

                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) { throw new Error("Sessão inválida. Por favor, faça o login novamente."); }

                    const { data: profile } = await supabase.from("usuarios").select("nome").eq("user_id", user.id).single();
                    if (!profile) { throw new Error("Não foi possível encontrar seu perfil de usuário."); }

                    const produto = document.getElementById("produto").value.trim();
                    const local = document.getElementById("local").value.trim();
                    const precoFormatado = precoInput.value;
                    const precoNumerico = parseFloat(precoFormatado.replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.'));
                    const descricao = document.getElementById("descricao").value.trim();
                    const contato = telefoneMask.unmaskedValue;

                    if (!produto || !local || isNaN(precoNumerico) || precoNumerico <= 0 || !descricao || !contato) {
                        throw new Error("Por favor, preencha todos os campos do anúncio corretamente.");
                    }
                    
                    const files = [
                        document.getElementById('imagem1').files[0],
                        document.getElementById('imagem2').files[0],
                        document.getElementById('imagem3').files[0]
                    ].filter(Boolean);
                    if (files.length === 0) { throw new Error("Por favor, selecione pelo menos uma imagem."); }
                    
                    const imagens = [];
                    for (const file of files) {
                        const sanitizedName = sanitizeFilename(file.name);
                        const path = `produtos/${user.id}/${Date.now()}_${sanitizedName}`;
                        const { error: uploadError } = await supabase.storage.from('imagens').upload(path, file);
                        if (uploadError) throw new Error(`Erro no upload da imagem: ${uploadError.message}`);
                        const { data: urlData } = supabase.storage.from('imagens').getPublicUrl(path);
                        imagens.push(urlData.publicUrl);
                    }
                    
                    const { error: insertError } = await supabase.from("produtos").insert({
                        user_id: user.id, nome_usuario: profile.nome,
                        produto, local, preco: precoNumerico, descricao, contato, imagens,
                        data: new Date().toISOString()
                    });

                    if (insertError) throw insertError;

                    const popup = document.createElement("div");
                    popup.classList.add("popup-cadastro");
                    popup.innerHTML = `
                        <div class="checkmark-container">
                            <svg class="checkmark" viewBox="0 0 52 52">
                                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
                                <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16"/>
                            </svg>
                        </div>
                        <strong>Anúncio enviado para análise com sucesso!</strong>
                    `;
                    document.body.appendChild(popup);
                    setTimeout(() => {
                        popup.style.animation = "fadeOut 0.6s ease forwards";
                        popup.addEventListener("animationend", () => {
                            popup.remove();
                            window.location.replace("meus-anuncios.html");
                        });
                    }, 3000);

                } catch (err) {
                    console.error("Erro ao publicar anúncio:", err);
                    alert("Falha ao publicar: " + err.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Publicar";
                }
            });
        });
    </script>
</body>
</html>