<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meus Anúncios - Ocean Coffee</title>
    <link rel="icon" href="IMG/Loginho2.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="CSS/styles.css"> <style>
        /* ESTILOS GERAIS */
        :root { --color-primary: #0047a3; --color-danger: #dc3545; --color-success: #28a745; --color-warning: #ffc107; --color-text: #212529; --color-text-muted: #6c757d; --color-background: #f8f9fa; --color-surface: #ffffff; --color-border: #e9ecef; --font-family-main: 'Inter', sans-serif; }
        body { background-color: var(--color-background); font-family: var(--font-family-main); color: var(--color-text); margin: 0; }
        .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .dashboard-main { overflow-y: auto; padding: 2.5rem; }

        /* SIDEBAR */
        .dashboard-sidebar { background-color: var(--color-surface); border-right: 1px solid var(--color-border); display: flex; flex-direction: column; padding: 1.5rem; }
        .sidebar-header { padding: 0 0.5rem 1.5rem 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); text-align: center; }
        .sidebar-header .logo-img { height: 50px; }
        .user-profile-summary { text-align: center; margin-bottom: 2rem; }
        .user-profile-summary .avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; margin: 0 auto 1rem auto; }
        .user-profile-summary h3 { font-size: 1.1rem; font-weight: 600; margin: 0; }
        .user-profile-summary p { font-size: 0.875rem; color: var(--color-text-muted); word-break: break-all; }
        .sidebar-nav { flex-grow: 1; display: flex; flex-direction: column; }
        .sidebar-nav-main { display: flex; flex-direction: column; gap: 0.5rem; }
        .sidebar-nav-logout { margin-top: auto; }
        .sidebar-nav a { display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; border-radius: 8px; text-decoration: none; color: var(--color-text-muted); font-weight: 500; transition: all 0.2s ease; }
        .sidebar-nav a:hover { background-color: var(--color-background); color: var(--color-text); }
        .sidebar-nav a.active { background-color: var(--color-primary); color: white; }
        .sidebar-nav a i { width: 20px; text-align: center; font-size: 1.1rem; }
        #logout-btn:hover { color: var(--color-danger); background-color: #fbebee; }
        
        /* CONTEÚDO PRINCIPAL E CARDS DE ANÚNCIO */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-header h1 { font-size: 2rem; font-weight: 700; margin: 0; }
        .ad-list { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .ad-card { display: flex; align-items: center; gap: 1.5rem; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; transition: box-shadow 0.2s ease; }
        .ad-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .ad-image { width: 120px; height: 120px; border-radius: 8px; object-fit: cover; }
        .ad-info { flex-grow: 1; }
        .ad-info h3 { font-size: 1.2rem; font-weight: 600; margin: 0 0 0.5rem 0; }
        .ad-info p { margin: 0; color: var(--color-text-muted); }
        .ad-price { font-size: 1.1rem; font-weight: 500; color: var(--color-primary); }
        .ad-status { display: inline-block; padding: 4px 10px; font-size: 0.8rem; font-weight: 600; border-radius: 20px; color: white; }
        .ad-status.approved { background-color: var(--color-success); }
        .ad-status.pending { background-color: var(--color-warning); color: var(--color-text); }
        .ad-status.rejected { background-color: var(--color-danger); }
        .ad-actions { display: flex; gap: 1rem; }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--color-text-muted); font-size: 1.1rem; padding: 5px; transition: color 0.2s; }
        .action-btn.delete:hover { color: var(--color-danger); }

        /* FILTROS */
        .filter-bar { display: flex; gap: 0.5rem; margin-bottom: 2rem; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; padding: 0.5rem; }
        .filter-btn { background-color: transparent; border: none; padding: 0.625rem 1rem; border-radius: 6px; font-family: var(--font-family-main); font-size: 0.9rem; font-weight: 500; color: var(--color-text-muted); cursor: pointer; transition: all 0.2s ease; }
        .filter-btn:hover { background-color: var(--color-background); color: var(--color-text); }
        .filter-btn.active { background-color: var(--color-primary); color: white; }

        /* MENSAGEM DE "NENHUM ANÚNCIO" */
        #no-ads-message { text-align: center; padding: 4rem; background-color: var(--color-surface); border-radius: 12px; border: 1px dashed var(--color-border); }
        #no-ads-message h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        #no-ads-message p { color: var(--color-text-muted); margin-bottom: 1.5rem; }
        .new-ad-btn { display: inline-block; text-decoration: none; background-color: var(--color-primary); color: white; padding: 0.875rem 1.5rem; border-radius: 8px; font-weight: 500; transition: background-color 0.2s; }
        .new-ad-btn:hover { background-color: #00337a; }

        /* ESTILOS DOS POP-UPS (INTEGRADOS) */
        .popup-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        .popup { display: flex; align-items: center; min-width: 300px; padding: 16px 22px; border-radius: 8px; color: white; font-family: 'Inter', sans-serif; font-size: 0.95rem; font-weight: 500; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); transform: translateX(calc(100% + 20px)); opacity: 0; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .popup.show { transform: translateX(0); opacity: 1; }
        .popup i { font-size: 1.25rem; margin-right: 14px; }
        .popup.success { background-color: #28a745; }
        .popup.error { background-color: #dc3545; }
        .popup.info { background-color: #0d6efd; }
        .confirmation-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9998; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .confirmation-overlay.show { opacity: 1; }
        .confirmation-modal { background-color: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 400px; width: 90%; transform: scale(0.9); opacity: 0; transition: all 0.3s ease; }
        .confirmation-overlay.show .confirmation-modal { transform: scale(1); opacity: 1; }
        .confirmation-modal h3 { font-size: 1.25rem; font-weight: 600; margin-top: 0; margin-bottom: 0.75rem; }
        .confirmation-modal p { color: #6c757d; margin-bottom: 1.75rem; }
        .confirmation-actions { display: flex; gap: 1rem; justify-content: center; }
        .confirmation-actions button { border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-family: 'Inter', sans-serif; font-weight: 500; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; }
        .confirmation-btn-cancel { background-color: #e9ecef; color: #495057; }
        .confirmation-btn-cancel:hover { background-color: #dee2e6; }
        .confirmation-btn-confirm { background-color: #dc3545; color: white; }
        .confirmation-btn-confirm:hover { background-color: #c82333; }

        @media (max-width: 992px) { .dashboard-layout { grid-template-columns: 1fr; } .dashboard-sidebar { display: none; } .dashboard-main { padding: 1.5rem; } }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="dashboard-sidebar">
            <div class="sidebar-header"><a href="index.html"><img src="IMG/Loginho2.png" alt="Logo Ocean Coffee" class="logo-img"></a></div>
            <div class="user-profile-summary">
                <div class="avatar" id="avatar-inicial"></div>
                <h3 id="welcome-message">Carregando...</h3>
                <p id="user-email-sidebar"></p>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-main">
                    <a href="perfil.html"><i class="fas fa-user-circle"></i><span>Meu Perfil</span></a>
                    <a href="meus-anuncios.html" class="active"><i class="fas fa-bullhorn"></i><span>Meus Anúncios</span></a>
                    <a href="anuncie.html"><i class="fas fa-plus-circle"></i><span>Anunciar Novo</span></a>
                </div>
                <div class="sidebar-nav-logout"><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></div>
            </nav>
        </aside>
        <main class="dashboard-main">
            <div class="page-header">
                <h1>Meus Anúncios</h1>
            </div>

            <div class="filter-bar" id="filter-bar">
                <button class="filter-btn active" data-filter="todos">Todos</button>
                <button class="filter-btn" data-filter="aprovados">Aprovados</button>
                <button class="filter-btn" data-filter="pendentes">Pendentes</button>
                <button class="filter-btn" data-filter="rejeitados">Rejeitados</button>
            </div>

            <div class="ad-list" id="ad-list">
                </div>
            <div id="no-ads-message" style="display: none;">
                <h2>Você ainda não tem anúncios.</h2>
                <p>Que tal criar seu primeiro anúncio e começar a vender?</p>
                <a href="anuncie.html" class="new-ad-btn"><i class="fas fa-plus-circle"></i> Anunciar Agora</a>
            </div>
        </main>
    </div>

 <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.1/+esm";
    
    // --- LÓGICA DE SEGURANÇA E POP-UPS (INTEGRADA) ---
    const supabaseUrl = "https://uldxazlnnpuoxfzsovmu.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZHhhemxubnB1b3hmenNvdm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3Mjg2NzgsImV4cCI6MjA2NDMwNDY3OH0.fyToys8_muc1XyUebJ19gxGEkCVM_cXg80UJR894xQY";
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function protegerPagina() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.replace('Login.html'); }
    }
    protegerPagina();

    function ensurePopupContainer() { let c = document.getElementById('popup-container'); if (!c) { c = document.createElement('div'); c.id = 'popup-container'; c.className = 'popup-container'; document.body.appendChild(c); } return c; }
    function showPopup(message, type = 'info', duration = 3500) { const c = ensurePopupContainer(); const p = document.createElement('div'); p.className = `popup ${type}`; let i = 'fas fa-info-circle'; if (type === 'success') i = 'fas fa-check-circle'; if (type === 'error') i = 'fas fa-times-circle'; p.innerHTML = `<i class="${i}"></i> <div>${message}</div>`; c.prepend(p); requestAnimationFrame(() => p.classList.add('show')); setTimeout(() => { p.classList.remove('show'); p.addEventListener('transitionend', () => p.remove()); }, duration); }
    
    function showConfirmationPopup(title, message, options = {}) {
        const { confirmText = 'Sim, Excluir', cancelText = 'Cancelar', confirmBtnClass = 'delete' } = options;
        return new Promise((resolve) => {
            const o = document.createElement('div');
            o.className = 'confirmation-overlay';
            let buttonStyle = 'background-color:#dc3545; color:white;';
            if (confirmBtnClass === 'logout') { buttonStyle = 'background-color:#dc3545; color:white;'; }
            o.innerHTML = `<div class="confirmation-modal"><h3>${title}</h3><p>${message}</p><div class="confirmation-actions"><button class="confirmation-btn-cancel">${cancelText}</button><button class="confirmation-btn-confirm" style="${buttonStyle}">${confirmText}</button></div></div>`;
            const c = (r) => { o.classList.remove('show'); o.addEventListener('transitionend', () => { o.remove(); resolve(r); }); };
            o.querySelector('.confirmation-btn-cancel').addEventListener('click', () => c(false));
            o.querySelector('.confirmation-btn-confirm').addEventListener('click', () => c(true));
            document.body.appendChild(o);
            requestAnimationFrame(() => o.classList.add('show'));
        });
    }

    // --- LÓGICA DA PÁGINA "MEUS ANÚNCIOS" ---
    document.addEventListener("DOMContentLoaded", async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const { data: profile } = await supabase.from("usuarios").select("nome, email").eq("user_id", user.id).single();
        if (profile) {
            document.getElementById('welcome-message').textContent = profile.nome.split(' ')[0];
            document.getElementById('user-email-sidebar').textContent = profile.email;
            document.getElementById('avatar-inicial').textContent = profile.nome.charAt(0).toUpperCase();
        }

        const adList = document.getElementById('ad-list');
        const noAdsMessage = document.getElementById('no-ads-message');
        const filterBar = document.getElementById('filter-bar');

        async function loadAds(filter = 'todos') {
            let ads = [];
            let error = null;

            if (filter === 'aprovados') {
                const { data, error: approvedError } = await supabase.from('aprovados').select('*').eq('user_id', user.id).order('data_aprovacao', { ascending: false });
                if (approvedError) error = approvedError;
                ads = data || [];
            } else if (filter === 'pendentes' || filter === 'rejeitados') {
                let query = supabase.from('produtos').select('*').eq('user_id', user.id);
                if (filter === 'pendentes') {
                    query = query.is('aprovado', null);
                } else { // 'rejeitados'
                    query = query.eq('aprovado', false);
                }
                const { data, error: productError } = await query.order('data', { ascending: false });
                if (productError) error = productError;
                ads = data || [];
            } else { // filter === 'todos'
                const { data: approvedAds, error: approvedError } = await supabase.from('aprovados').select('*').eq('user_id', user.id);
                const { data: otherAds, error: productError } = await supabase.from('produtos').select('*').eq('user_id', user.id);

                if (approvedError || productError) {
                    error = approvedError || productError;
                } else {
                    const combined = [...(approvedAds || []), ...(otherAds || [])];
                    combined.sort((a, b) => new Date(b.data_aprovacao || b.data) - new Date(a.data_aprovacao || a.data));
                    ads = combined;
                }
            }
            
            if (error) {
                showPopup('Erro ao carregar seus anúncios.', 'error');
                console.error(error);
                return;
            }

            renderAds(ads, filter);
        }

        function renderAds(ads, filter) {
            adList.innerHTML = '';
            
            if (ads.length === 0) {
                noAdsMessage.style.display = 'block';
                noAdsMessage.querySelector('h2').textContent = (filter === 'todos') ? `Você ainda não tem anúncios.` : `Você não tem anúncios ${filter}.`;
                noAdsMessage.querySelector('p').textContent = (filter === 'todos') ? 'Que tal criar seu primeiro anúncio e começar a vender?' : 'Tente selecionar outro filtro ou crie um novo anúncio.';
            } else {
                noAdsMessage.style.display = 'none';
                ads.forEach(ad => {
                    let statusClass, statusText, dateText, dateValue;
                    
                    if (ad.data_aprovacao) { // Anúncio vem da tabela 'aprovados'
                        statusClass = 'approved';
                        statusText = 'Aprovado';
                        dateText = 'Aprovado em';
                        dateValue = ad.data_aprovacao;
                    } else { // Anúncio vem da tabela 'produtos'
                        if (ad.aprovado === false) {
                            statusClass = 'rejected';
                            statusText = 'Rejeitado';
                        } else {
                            statusClass = 'pending';
                            statusText = 'Pendente';
                        }
                        dateText = 'Publicado em';
                        dateValue = ad.data;
                    }
                    
                    const adCard = document.createElement('div');
                    adCard.className = 'ad-card';
                    adCard.setAttribute('data-id', ad.id);
                    adCard.setAttribute('data-table', ad.data_aprovacao ? 'aprovados' : 'produtos');

                    adCard.innerHTML = `
                        <img src="${ad.imagens[0]}" alt="${ad.produto}" class="ad-image">
                        <div class="ad-info">
                            <h3>${ad.produto}</h3>
                            <p class="ad-price">${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(ad.preco)}</p>
                            <p>${dateText}: ${new Date(dateValue).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <div><span class="ad-status ${statusClass}">${statusText}</span></div>
                        <div class="ad-actions">
                            <button class="action-btn delete" title="Excluir anúncio"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    adList.appendChild(adCard);
                });
            }
        }

        filterBar.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelector('.filter-btn.active').classList.remove('active');
                e.target.classList.add('active');
                loadAds(e.target.getAttribute('data-filter'));
            }
        });

        adList.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete');
            if (deleteButton) {
                const adCard = deleteButton.closest('.ad-card');
                const adId = adCard.dataset.id;
                const adTable = adCard.dataset.table;
                
                const confirmed = await showConfirmationPopup(
                    'Excluir Anúncio', 
                    'Tem certeza que deseja excluir este anúncio? Esta ação não pode ser desfeita.',
                    { confirmText: 'Sim, Excluir', confirmBtnClass: 'delete' }
                );

                if (confirmed) {
                    const { error: dbError } = await supabase.from(adTable).delete().eq('id', adId);
                    if (dbError) {
                        showPopup('Erro ao excluir o anúncio.', 'error');
                        return;
                    }
                    showPopup('Anúncio excluído com sucesso!', 'success');
                    loadAds(document.querySelector('.filter-btn.active').getAttribute('data-filter'));
                }
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async (e) => { 
            e.preventDefault(); 
            const userConfirmed = await showConfirmationPopup(
                'Confirmar Saída', 'Você tem certeza que deseja sair da sua conta?',
                { confirmText: 'Sim, Sair', confirmBtnClass: 'logout' }
            );
            if (userConfirmed) { await supabase.auth.signOut(); window.location.replace("index.html"); }
        });

        await loadAds();
    });
</script>
</body>
</html>